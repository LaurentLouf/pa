\part{Partie informatique, électronique}

L'enjeu de cette partie est grand : il s'agit d'une part de détecter la balle, sa position ainsi que les composantes de son mouvement : vitesses de rotation et vitesses de translation. Le système devant pouvoir être utilisé pour tout type de joueurs, on peut estimer que le pire des scénarios est celui d'un jeu d'échange de grand joueur où la balle se déplace en moyenne à 100  km/h ce qui impose de fortes contraintes temporelles pour les parties acquisition et commande. D'autre part, il faut aussi commander le mur pour qu'il se trouve dans la bonne position pour renvoyer la balle où cela a été décidé par l'algorithme de jeu (non étudié ici), ce qui devra prendre en compte de la position du joueur, qu'il faudra donc déterminer.\\

En supposant que la balle est tapée en fond de court et que le mur se trouve sur le fond de court opposé, le système dispose de moins d'une seconde pour faire l'acquisition et déplacer le mur en conséquence. Mais cette hypothèse est peu probable et il y a de grandes chances pour qu'on ne détecte la balle qu'au moment de son passage au-dessus du filet. De plus, le mur se trouvera sur la ligne de service ce qui ne laisse donc au système qu'environ 200ms pour capter la balle et se déplacer en fonction. \\

C'est pour ces raisons qu'un certain nombre de solutions techniques ont du être envisagées aussi bien pour la partie détection de la balle, détection du joueur que déplacement du mur.

\chapter{Détection de la balle}


L'enjeu de cette partie est de détecter la position de la balle ainsi que les composantes de son mouvement : vitesses de translation ainsi que vitesses de rotation. 

Si les premières sont assez faciles à trouver (il suffit de détecter la balle dans deux positions assez proches), les vitesses de rotation se révèlent plus compliquées à obtenir du fait des vitesses de rotation pouvant atteindre 75 tr/s, soit une rotation toutes les 13ms. 

Si on veut détecter cette rotation, dans le cas d'une caméra, il faudrait donc pouvoir au moins acquérir deux images durant cette rotation soit une image toute les 6ms environ. Il a donc été nécessaire de faire un peu d'exploration de différentes techniques d'acquisition afin de trouver la solution la plus adaptée à notre problème.













\section{Détection de la position et de la vitesse de translation}



\subsection{Détection par laser}

\subsubsection{Rideaux de lasers}

Une première méthode pour détecter la position de la balle à différents instants serait d'utiliser des barrières de lasers comme on peut en trouver dans l'industrie pour limiter l'accès à des machines dangeureuses. On peut en voir notamment sur la figure \ref{img_rideaulasers}.

\begin{figure}[h]
\begin{center}
\includegraphics[width=\textwidth]{rideaulaser.png}
\caption{Rideau laser}
\label{img_rideaulasers}
\end{center}
\end{figure}

On a donc besoin d'autant de ces systèmes qu'on veut de positions de la balle (pour la partie calcul et détermination de la trajectoire de la balle), ce qui peut donc vite se révéler très contraignant, tant en termes de coûts que de modularité, mais aussi de positionnement et donc de délai avant impact de la balle avec le mur. En effet, un tel type de procédé peut comporter des risques pour l'utilisateur (utilisation de lasers) et ne peut donc pas pointer vers le joueur. On pourrait donc placer ces capteurs de part et d'autre du filet, mais on limite donc de fait le temps dont on dispose pour déplacer le mur. \\

De plus, il faut un espacement maximal entre deux capteurs lasers de 5cm (une balle de tennis en faisant un peu plus de 6), on a donc besoin d'un nombre de capteurs proportionnel à la hauteur maximale à laquelle on veut détecter le passage de la balle, ce qui aura donc une influence directe sur le prix. Enfin, la plupart des solutions trouvées dans l'industrie ne permettent que de détecter le franchissement (d'objets plus ou moins petits selon l'espacement entre les lasers) et non pas la position où l'objet a traversé le rideau. Il doit néanmoins être possible d'adapter ces solutions, mais cela demanderait du travail supplémentaire. 


\subsubsection{Balayage laser}

\paragraph{Balayage 2D\\}

Une autre solution serait d'utiliser un capteur basé sur un balayage laser. Le principe est quasiment similaire au précédent, c'est-à-dire qu'un balayage 2D nécessiterait d'avoir autant de capteurs qu'on veut de positions de la balle. De la même manière que précédemment, la sécurité de l'utilisateur est aussi à prendre en jeu. \\

On peut donc imaginer un système de capteurs suspendus au plafond, il faut donc prendre en compte la hauteur à laquelle se trouve le capteur pour pouvoir trouver la résolution angulaire minimale à avoir pour pouvoir détecter la balle. À 5m de hauteur, avec un seul capteur pour toute la largeur du terrain, on doit avoir une ouverture angulaire de 94$^{\circ}$, une portée maximale de 7.5m et quelques calculs de trigonométrie donnent une résolution angulaire de minimum 0.25$^{\circ}$. Cependant, à la vue des caractéristiques de différents capteurs de ce type, il ne semble pas que cela soit très contraignant \\ 

La vitesse de la balle va aussi dans ce cas imposer de fortes contraintes sur la fréquence de réalisation des scans. La balle faisant 6cm de diamètre, la taille du faisceau étant d'environ 1cm à la distance citée précédemment, il faut donc que la balle ne parcourt pas plus de 5cm entre deux scans complets, ce qui donne donc une fréquence de balayage de 560Hz. \\

L'ensemble de ces caractéristiques (portée, résolution angulaire et fréquence de scan) semble pour l'instant très dur à trouver (aucune référence chez SICK, et la meilleure référence chez Pulse-In\footnote{http://www.triple-in.de/english/products/2d-laser-scanners/pas/} ne convient pas à nos besoins). 


\paragraph{Balayage 3D\\}

Une solution pour ne pas avoir à multiplier les capteurs est d'utiliser un capteur qui fasse un balayage 3D, ce qui permet donc d'avoir plusieurs positions de la balle avec un seul capteur. Néanmoins, il semble impossible d'avoir un capteur qui puisse avoir une cadence suffisamment élevée pour réaliser ces mesures et le prix d'un tel capteur serait tout simplement beaucoup trop élevé, sachant que la meilleure référence trouvée\footnote{http://www.robotshop.com/eu/fr/capteur-3d-balayage-laser-precision.html} coûte déjà plus de 50 000\texteuro. Malheureusement, même à ce prix, la vitesse de scan est bien trop faible pour pouvoir être utilisée dans le cadre de notre application. 	

\begin{figure}[h]
\begin{center}
\includegraphics{laserbalyage3d.png}
\caption{Capteur laser à balayage 3D}
\label{img:laser3d}
\end{center}
\end{figure}

\subsubsection{Algorithmie}

La partie algorithmie d'une telle méthode de détection est très simple : le capteur fournit les distances des objets détectés à tous les angles (ou toutes les positions) parcourues par le système. Après avoir réalisé une mesure avec le terrain vide, on note les valeurs obtenues quand il n'y a aucune balle présente, on peut donc ensuite comparer à ces valeurs de référence les nouvelles valeurs et en déduire à quel angle et à quelle distance on a détecté quelque chose. \\ 

Il faut déterminer si le quelque chose est bien la balle et non le joueur (dans le cas où on fait un balayage, sinon on place les rideaux lasers de part et d'autre du filet et il semble évident que le joueur ne va pas jouer au filet contre un mur). Pour ce faire, il suffit de regarder s'il existe plusieurs angles pour lesquels on a détecté quelque chose. Avec une résolution angulaire choisie de manière intelligente, on est sûr que la balle ne puisse pas traverser plus d'un ou deux rayons. On peut donc être sûr dans les autres cas que c'est le joueur qui est détecté.\\ 

Cette solution est donc une solution assez coûteuse et la technologie d'aujourd'hui ne semble pas pouvoir remplir nos besoins en termes de vitesse de détection, de portée et de résolution à la fois. Il s'agit finalement que d'une tâche assez simple et il doit donc exister d'autres solutions qui puissent répondre à nos besoin pour un coût bien moindre. 


\subsection{Détection par caméra}

Une solution alternative à la détection par laser est la détection par caméra. Si cette méthode pose quelques problèmes que l'on a pas avec la détection par laser, elle en résoud certain. On capte en effet une assez grande surface, on n'a donc pas besoin d'une vitesse excessivement élevée pour avoir la balle dans le champ (ce qui est par contre très problématique avec le laser). On a par contre des problèmes de flou que l'on n'avait pas avant. La détection de la balle est aussi plus problématique puisqu'il faut la distinguer du reste de l'environnement qui est visuellement très riche et bourré d'informations, dont la très grande majorité est inutile dans notre cas. Bien positionnée, une caméra peut aussi servir à détecter le joueur ce qui est le sujet d'une autre partie. \\ 

Dans le cas où on utilise une caméra, il convient de chosir celle-ci correctement en fonction de notre application. Outre le nombre d'images par secondes, il faut aussi déterminer ses autres caractéristiques : temps d'exposition, sensibilité, type d'objectif... ainsi que son positionnement : au-dessus du terrain ou sur les côtés ? 

\subsubsection{Nombre d'images par seconde et temps d'exposition}

Il convient de rappeler pour cette partie que notre balle se déplace dans le pire des cas à environ 100 km/h, soit environ 28 m/s. Si on ne veut pas avoir de flou de bougé sur la balle, pour l'avoir bien nette, on peut soit augmenter fortement le nombre d'images par seconde, soit définir un temps d'exposition pour la prise des images (ce qui met de fait de côté les caméras grand public puisque diminuer ainsi le temps d'exposition créé un effet saccadé sur le mouvement, ce qui est contraire à la volonté d'avoir des vidéos fluides). La première solution semble quelque peu sous optimale puisque avoir un nombre d'images par seconde élevé (de la centaine à quelques centaines d'images par seconde) est généralement très cher alors que les caméras permettant de régler le temps d'exposition sont beaucoup plus abordables. \\

Avec des caméras rapides, tournant à 60 images par seconde, on a un déplacement entre deux prises de vues d'environ 50 cm, ce qui d'après la simulation, permet d'approximer la trajectoire de la balle à une droite. ce qui empêche d'utiliser une caméra grand public de ce type est que, dans celles-ci, le temps d'exposition correspond à la moitié du temps entre deux images, soit ici 1/120 s, donnant ainsi un déplacement de 25 cm. Avec un tel déplacement, on aura donc une traînée floue assez difficilement exploitable. Cependant, en restant sur une vitesse d'acquisition de 60 images par seconde, si on diminue le temps d'exposition, on peut parvenir à obtenir des images tout à fait nettes. Le flou de bougé existe seulement si l'objet en mouvement parcoure plus d'un pixel sur l'image pendant le temps d'exposition, on choisira donc le temps d'exposition en fonction des caractéristiques suivantes de la caméra. 


\subsubsection{Positionnement de la caméra}

Le principal problème relatif au positionnement des caméras est celui de la distance de détection de la balle par rapport au mur. Si on positionne deux caméras de part et d'autre du filet au niveau de celui-ci, on détecte la balle toujours au niveau de celui-ci, ce qui nous laisse donc approximativement 200 ms pour faire tourner les algorithmes et déplacer le mur, ce qui est très peu. \\


On peut aussi positionner la caméra au-dessus du terrain, et plus particulièrement au-dessus de la partie du terrain du joueur, l'autre partie (entre le filet et le mur) étant assez peu intéressante. Le grand avantage d'un tel positionnement est qu'il permet de suivre la balle et de la détecter donc bien avant qu'elle ne passe au niveau du filet. On gagne ainsi un temps précieux puisque la contrainte temporelle est ici notre contrainte la plus forte. On partira donc sur cette solution, en supposant une installation de la caméra à 5 mètres de haut. Cela impose malheureusement une installation un peu plus complexe.


\subsubsection{Résolution d'image et angle de vue}

Sachant maintenant où sera placée la caméra, on peut donc faire les calculs nécessaires à la détermination de la résolution souhaitée ainsi que de l'angle de vue qu'on souhaite avoir.

Pour l'angle de vue, un calcul assez simple donne la formule suivante : 

$$ \alpha = \arctan ( \frac{H}{L}) $$

Où $\alpha$ est l'angle de vue, H la hauteur à laquelle où est installée la caméra et L la largeur du terrain. Le terrain étant quasiment carré, on prendra une caméra dont le capteur est carré, et en prenant L comme la largeur du terrain, il ne nous manquera qu'une très petite partie (moins d'un mètre) en partant du filet, ce qui n'aura pour seule conséquence que de ne pas permettre le jeu au filet, ce qui n'est généralement pas la volonté d'un joueur en entraînement. On pourrait aussi utiliser plusieurs caméras, deux ou quatre, pour couvrir tout le terrain. \\ 

Dans le cas d'une seule caméra, avec une résolution de 2048*2048, on obtient, à raz du sol, une résolution de 7.4mm/pixel, ce qui donne 9 pixels pour la balle, et à un mètre du sol, on a 6.0mm/pixel, ce qui donne 11 pixels pour la balle. Ces chiffres peuvent paraître particulièrement faible, mais on peut constater sur la figure \ref{img_detectionballe} qu'on arrive très bien à détecter la balle même quand elle ne fait que 13 pixels de diamètre.

\subsubsection{Caractéristiques finales de la caméra}

Maintenant que nous avons les données sur la résolution de la caméra qu'il est souhaitable d'avoir, nous pouvons donc déterminer le temps d'exposition minimal qu'il convient de prendre pour ne pas avoir de flou de bougé. On prend le cas où la balle est jouée assez haute (3 mètres), on a donc environ 3 mm / pixel. On veut donc que la balle ne se déplace pas de plus de la moitié d'un pixel pendant le temps d'exposition, ce qui donne donc un temps d'exposition minimal de 500$\mu$s. \\

Le problème d'un temps d'exposition aussi faible est que l'image peut ne pas être très lumineuse. Il faut donc une sensibilité assez élevée pour la caméra afin d'avoir une luminosité correcte. La figure \ref{img_detectionballe} montre une photo prise avec un temps d'exposition de 250$\mu$s avec une sensibilité assez élevée de 6400 ISO et une ouverture de F/2.8. Si une telle sensibilité est difficilement atteignable en vidéo, les objectifs permettant d'avoir un tel angle de vue ont généralement une ouverture qui peut aller jusqu'à F/1.2, ce qui rattrape la faiblesse en luminosité. La caméra 4M140 - CXp de Flare\footnote{http://www.adept.net.au/cameras/ioi/pdf/FlareCXP.pdf} semble être dans ce cas une caméra qui répond à tous nos critères, qui sont résumés ci-après : 




% ####################################
% FIN DE PHRASE ?
% ###################################

\subsubsection{Algorithmie}

\paragraph{Seuillage sur la teinte\\}

Nous avons donc développé notre algorithme de detection et de calcul de la position de la balle. La première étape était de detecter les pixels correpondant à la balle dans l'image. La balle étant jaune vif nous avons décidé de nous baser sur la teinte pour detecter les pixels en question. La première étape de l'algorithme est donc de convertir l'image définie dans l'espace RGB (Red-Green-Blue : rouge, vert, bleu) vers l'espace HSV (Hue-Saturation-Value : teinte, saturation, valeur). Nous avons constaté que la balle entière avait une teinte comprise entre 80 et 95 (on peut réduire l'écart mais avec le risque qu'une partie de la balle ne soit pas détecté, en contrepartie on récupère moins de bruit). Nous appliquons donc une fonction de seuil qui remplace les pixels dont la teinte est entre nos valeurs limites par un pixel blanc et les autres par un pixel noir.\\

\paragraph{Suppression du bruit\\}

Puis on obtient une image avec la balle de tennis qui apparait en blanc sur une image noire, mais le tout avec beaucoup de bruit comme on peut le voir sur la figure \ref{img_filtragecouleur}. Pour supprimer ce bruit nous avons utilisé des fonctions de morphologie mathématique : érosion et dilatation. L'application d'une dilatation sur une érosion de même élement structurant constitue une ouverture morphologique qui a tendance à eliminer les petits éléments isolés. Ainsi les petits blocs de pixels correspondants au bruits sont éliminés tandis que la balle de tennis qui est un bloc de pixel plus grand que l'élément structurant reste en place. \\ 

Lors de nos tests nous avions beaucoup de bruit à cause notemment de reflets de la balle sur des surfaces brillantes et de nombreuses couleur claires dont la teinte était proches de celle de la balle, nous avons donc opté pour un élément structurant assez gros : un carré de 10 pixels de coté. Il faut donc que la balle soit représentée par plus de 10 pixels pour ne pas être supprimée, ou diminuer la taille de l'élément structurant en supprimant les sources de bruit sur le terrain : pas de vert sur le sol, car proche du jaune en teinte ; pas d'éléments réfléchissant, pas d'éléments jaunes, etc. On comprend aussi l'intéret d'avoir une résolution confortable sur la caméra (FullHd minimum ce qui correspond au minimum à 6 pixels pour la balle au sol, 2500x2000 pixels étant parfait : 12 pixels au sol). Il est à noter qu'il est impossible d'effectuer une érosion ou une dilatation avec un élément structurant plus grand qu'un carré de coté 7. Nous avons donc appliqué deux érosions puis deux dilatations succesives avec un carré de coté 5 comme élément structurant car la composé de 2 érosion/dilatation est une érosion/dilatation avec un élément structurant égal au premier dilaté par le deuxième.\\



\begin{figure}
\centering
\subfigure[Image originale]{\includegraphics[width=0.45\textwidth]{photo_traitement1.png}}
\subfigure[Image après filtrage couleur]{\includegraphics[width=0.45\textwidth]{photo_traitement2.png} \label{img_filtragecouleur}}\\
\subfigure[Image après filtrage du bruit]{\includegraphics[width=0.45\textwidth]{photo_traitement3.png}}
\subfigure[Cercle détecté à la fin]{\includegraphics[width=0.45\textwidth]{photo_traitement4.png} \label{3figs-c}}
\caption{Différentes étapes de la détection de la balle}
\label{img_detectionballe}
\end{figure}

\paragraph{Détermination du contour et de la position de la balle\\}

On applique ensuite la fonction findContours de OpenCV, qui permet de trouver les pixels blanc qui forment des blocs et de déterminer les contours de ces blocs. Ensuite il faut déterminer le plus petit cercle englobant ces blocs afin d'obtenir une position en coordonnées de pixel, et un rayon. Pour cela on applique la fonction minEnclosingCircle de la library OpenCV qui nous permet d'avoir le cercle correspondant pour chaque contour. On peut donc récupérer les coordonnées du centre du cercle et son rayon.\\


\paragraph{Détermination de la position de la balle dans le repère lié au terrain de tennis\\}

Grâce à ces informations on peut détecter la position de la balle dans l'espace. Tout d'abord en supposant la caméra en hauteur qui regarde vers le bas, on va chercher à déterminer la profondeur de la balle (axe z, cf figure \ref{img_calculz}). Remarque : les angles ne sont pas orientés.\\

\begin{figure}[h]
\begin{center}
\includegraphics[width=\textwidth]{dessin_calcul_z.png}
\caption{Calcul de Z}
\label{img_calculz}
\end{center}
\end{figure}


$$ \frac{H}{2} = \tan ( \gamma + \frac{\alpha}{2} ) $$
$$ \frac{H - R_{balle}}{z} = \tan \gamma  $$
$$ z = \frac{H - R{balle}}{\tan \gamma} = \frac{z.\tan (\gamma + \frac{\alpha}{2}) - R_{balle}} {\tan \gamma}  $$
$$ z.(1 - \frac{\tan (\gamma + \frac{\alpha}{2})}{\tan \gamma}) = \frac{-R_{balle}}{\tan \gamma} $$
$$ z = \frac{R_{balle}}{\tan (\gamma + \frac{\alpha}{2}) - \tan \gamma}
$$

On trouve $\alpha$ et $\gamma$ de la manière suivante : on a un coefficient Pix2Rad qui dépend de l'angle d'ouverture de l'objectif de la caméra : si on a une longueur en pixel on la multiplie par ce coefficient pour avoir l'angle qu'il y a entre les 2 points représentés par ces pixels, du coup en considérant les coordonnées du point dans l'image en pixels (xPixels, yPixels) avec l'origine au centre de l'image :

$$ \alpha = 2.R_{balle}.Pix2Rad $$ 
$$ \gamma = Pix2Rad.\sqrt{xPixels^2 + yPixels^2} $$

Puis on récupère les coordonnées x et y avec un simple calcul de trigonométrie : on récupère les angles du point selon les axes x et y ($\alpha _x$ et $\alpha _y$) puis :
$$ x = z.\tan \alpha _x $$
$$ y = z.\tan \alpha _y $$


Pour avoir la vitesse il suffit juste de soustraire le nouveau vecteur position par l'ancien et diviser cette quantité par le pas de temps qui sépare la prise de deux images. Pour pouvoir estimer la trajectoire de la balle, il est nécessaire d'avoir trois vecteurs positions et donc deux vecteurs vitesses (explications plus détaillées dans la prochaine partie). 


\subsubsection{Performances}

% Bouger la partie perf dans la partie détection position  %
Compte tenu de la vitesse avec laquelle le système doit réagir, nous nous sommes fortement intéressé aux performances du traitement de l'image afin d'augmenter au maximum la fréquence de notre algorithme. Ce dernier prenait déjà 70-75ms pour une image avant toute optimisation, ce qui nous a fait douter de la possibilité de la réalisation de notre idée. Ensuite, en essayant sur un ordinateur de bureau récent et puissant, nous avons constaté un gain d'à peine 5ms par image, mais OpenCV n'utilisait pas toutes les ressources CPU, uniquement la moitié de la puissance sur place (les 4 coeurs tournaient à 50\% d'après le moniteur système). \\

Nous sommes donc décidés à faire passer les calculs par la carte graphique de cet ordinateur de bureau à travers le module OpenCL de OpenCV (c'est une carte AMD, le module gpu d'OpenCV est donc incompatible car écrit en CUDA), ce qui ne fût pas sans difficultés, notamment au niveau des pilotes sous Linux. Finalement après quelques jours de configuration le programme s'est mis à tourner sur GPU, et là les gains nous émerveillèrent ! Après application d'une ou 2 fonctions sur gpu le temps d'exécution tomba dans les environs de 50ms. Puis les optimisations diverses ainsi que le portage d'un maximum de fonctions sur GPU nous ont amené à un temps de calcul de 11.5ms par image, en prenant en compte que 3.2ms est due à l'acquisition de l'image à partir du fichier vidéo. Il sera à voir si ce temps serait beaucoup plus court avec un système en streaming plutôt qu'une lecture sur disque dur. Malgré notre bohneur face à cette explosion de performance, le taux de traitement ne plafonne qu'à 88Hz (en FullHD), encore très loin des fréquences des caméras haute vitesse, qui nous intéressaient par la suite (de l'ordre de 500Hz).\\

On obtient ce tableau \ref{perf_opencv} récapitulatif avec une vidéo 1080p (1920x1080) au format .MOV où il y a beaucoup de bruit (donc application de fonctions de suppression du bruit plus lourdes, plus de détection d'éléments) qui nécessite donc plus de temps à traiter.

\begin{table}[h]
	\centering
		\begin{tabular}{|c|c|c|c|}
		\hline
		Temps par image & CPU sans & CPU avec & GPU avec \\
		1080p en ms & optimisation & optimisation & optimisation \\
		\hline
		Lecture Image & NA & 4.1 & 3.06 \\
		\hline
		Filtrage & 38.05 & 29.08 & 2.27\\
		\hline
		Supression du bruit & 2.685 & 2.72 & 3.98\\
		\hline
		Determination des contours & 2.28 & 1.92 & 2\\
		\hline
		Total & 51.99 & 38.48 & 11.37\\
		\hline
		\textbf{Fréquence (Hz)} & \textbf{19.23} & \textbf{25.99} & \textbf{87.95}\\
		\hline
		\end{tabular}
	\caption{Temps de calcul par image 1920x1080}
	\label{perf_opencv}
\end{table}

\subsubsection{Amélioration de la technique}

Malgré tout nous avions imaginé utiliser une imagerie infrarouge pour obtenir directement une image en niveau de gris, où certaines parties de la balle réfléchiraient les infrarouges. Ainsi les traitements associés à cette image seraient largement réduits, au niveau du filtrage et de la suppression du bruit. Pour celà nous avons imaginé avoir un éclairage infrarouge qui illumine le demi-court de tennis où se trouve le joueur, et que la balle possède des parties réfléchissante qui ressortiront très clairement sur les images.\\

Pour celà nous avons pensé à coller des bandes réfléchissante sur la balle. Cependant cette solution apparait comme plus que limité car on modifie la surface de rebond de la balle donc sa réaction au sol, et la bande risque de se décoller à tout moment en raison des chocs qui sont appliqués sur cette zone. Nous avions donc imaginé ensuite d'appliquer quelque chose qui réfléchisse les infrarouges et qui adhère fortement à la balle. La zone qui nous paraissait encore la plus propice était la bande blanche parcourant la balle de tennis, car un peu creusée et qu'elle rentre moins en contact lors des rebonds. Et une peinture réfléchissante nous apparut comme une bonne solution car elle peut être appliquée finement sur un contour non droit et adhère relativement bien. De plus les peintures d'isolement utilisées dans le bâtiment sont des peintures réfléchissantes d'infrarouges et sont donc facilement trouvables dans le commerce et pour un prix tout à fait raisonable.\\

Le problème a encore eu lieu au niveau des caméras : au début nous avons regardé le choix en caméra à infrarouges à haute vitesse. Et le choix était assez limité, en général avec des résolution dérisoires proches du VGA, ce qui était trop peu pour notre traitement. Puis nous nous sommes dit qu'il suffirait de prendre une caméra haute vitesse classique et d'appliquer un filtre infrarouge physique devant son objectif (moins de 100€ pour un bon filtre) et donc que cette caméra ne capterait qu'un peu de rouge au niveau des pixels excités par le rayonnement infrarouge. Le problème est que nombre de caméras ont un niveau de sensibilité réduit au domaine du visible voire un spectre plus restraint n'atteignant même pas les infrarouges proches comme on peut le voir sur le graphe du spectre de réponse de la M3 en figure \ref{img_repspectrm3}. Les infrarouges qui passeraient le filtre n'exciteraient donc pas les capteur de la caméra et on obtiendrait alors une image tout simplement noire.\\

Pour palier au problème de sensibilité du capteur dans l'infrarouge proche, il est tout à fait envisageable de disposer des lampes à infrarouges assez puissantes autour du terrain. Mais il faut prendre en compte que cet éclairage aurait put aussi constituer une gêne pour le joueur, car ce rayonnement l'aurait chauffé comme le fait un radiateur, ce qui pendant un effort intense peut être très désagréable. 


\begin{figure}[h]
\begin{center}
\includegraphics[width=\textwidth]{histom3.jpg}
\caption{Réponse spectrale de la caméra M3}
\label{img_repspectrm3}
\end{center}
\end{figure}




\subsection{Conclusion}

Pour conclure quand à la détection de la position et de la vitesse linéaire de la balle, la solution de la caméra nous semble la plus pertinente, car le choix d'une caméra compatible apparait comme beaucoup plus aisé, tandis qu'il faut espérer qu'un modèle haut de gamme existe au niveau des lasers à balayage ; ou bien accumuler les lasers simples avec le surcoût qui s'en suit. Ce surcoût est aussi en faveur de la solution caméra, car une bonne caméra avec les réglages qu'il nous faut doit pouvoir être acquise pour environ 5000€, tandis qu'il faut compter à 5 chiffres minimum pour un système laser. Cependant le traitement d'images est bien plus coûteux en temps, ce qui n'est pas sans importance sur ce projet, mais d'après la section concernant les performances, on voit qu'il est tout à fait possible de considérer sérieusement cette option, qui, au final, nous parait la plus sensée. L'option utilsant le rayonnement infrarouge semble aussi une option à creuser puisqu'elle permet de réaliser des parties du traitement de l'image de manière physique, réduisant donc les temps de traitement. Nous avons aussi trouvé la réponse spectrale de la caméra de Flare qui présente une certaine sensibilité dans l'infrarouge proche, ce qui confirme le choix pour cette caméra. Néanmoins, faute de moyens, nous n'avons pu conclure sur la faisabilité d'une telle solution.




\section{Détection de la vitesse de rotation}

Un des éléments qui nous paraissait essentiel pour déterminer la trajectoire et le rebond de la balle était la vitesse de rotation de celle ci. En effet il apparait comme trivial qu'une balle qui tourne sur elle même par rapport à un axe parallèle à un plan ne rebondira pas de la même manière qu'une balle sans rotation. Pour le vérifier, il suffit pour celà de se munir d'une balle (de tennis ou autre) de la faire tourner vers soi en la laissant tomber verticalement au sol et la balle va rebondir vers soi.\\

Un autre phénomène rentre en jeu avec des vitesses de rotation relativement élevées, c'est l'effet Magnus. Cet effet découle de la mécanique des fluides. Quand la balle entre en rotation elle déplace des masses d'air et crée des différences de pression autour d'elle même. Ces différences de pression engendre naturellement une pression résultante qui se comporte comme une force. Celle ci peut être verticale et donc porter la balle vers le haut, comme l'est une aile d'avion, ou au contraire vers le bas. Cette effet peut bien sûr faire dévier la balle dans les autres direction suivant les axes de rotations, et on comprend alors tous l'intéret de ces effets qui peuvent dévier la balle d'un mètre dans un sport comme le tennis.\\

La vitesse de rotation maximum qu'un joueur de haut niveau peut fournir est d'environ 100 tours par seconde, ce qui ne pouvait donc pas être mesuré simplement, mais on considére que la vitesse de rotation de la balle est constante durant son trajet durant entre 0.5s et 1s.

\subsection{Caméra ultra-rapide}

Lors de notre première approche, nous nous sommes dit : Puisque la balle tourne très vite, mesurons la à très haute vitesse aussi, ainsi on décomposera aisément son comportement et donc sa vitesse de rotation selon les 3 axes. En nous fixant 100 tours par seconde comme limite, il faudrait voir un même point de la balle passer d'une position à une autre sans passer par la face cachée de la balle entre temps. En admettant que l'on voit bien un bon tiers, voire deux cinquièmes de la balle (les bords de la moitié visible ne sont pas de très bonne qualité et pas facilement exploitables). Nous avons ensuite considéré qu'il faudrait qu'un point ne puisse parcourir que la moitié de cette zone claire pour que l'on détermine la vitesse de rotation sans trop d'ambiguité. Ce qui au final nous fait un cinquième ou un sixième de balle qui défile à 100 tours par seconde entre 2 images, soit une caméra à 500-600 images par secondes minimum.\\

Nous avons donc effectué de nombreuses recherches de caméra de ce type avec une résolution correcte. En effet soit cette caméra sert à détecter la position et vitesse linéaire de la balle comme vu précédemment, soit elle vient se supplanter au système. Dans le premier cas il faut imaginer une caméra qui voit le demi terrain imaginons par dessus : la caméra devra alors être capable de couvrir 11.9 mètres en longueur et des motifs sur la balle. Au début nous avions imaginé traiter les bandes blanches se trouvant sur la balle, faisant 2 mm d'épaisseur en étant généreux. Ce qui nous fait un rapport de 5500 avec la balle au sol, c'est à dire qu'en ayant 5500 pixels de définition dans le sens de la longueur, on pouvait s'assurer d'avoir tout la longueur du demi-court et d'avoir la ligne blanche de la balle présente sur 1 pixel ... Bien sûr c'est en prenant les conditions extrêmes car la balle est rarement au sol mais en l'air ce qui la rapproche de la caméra et la grossit donc, et nous aurions put développer des marqueurs additionnels plus gros, et de couleur sûrement moins difficile à traiter que du blanc alors que le marquage des terrain est en blanc.\\

Cette solution fût vite abandonnée à cause de ce problème de résolution et des surcoûts en terme d'argent et de temps de traitement qu'elle engendrait. Néanmoins l'idée d'une caméra rapide nous semblait toujours être la meilleure solution ne nécessitant pas un matériel trop particulier de la part du tennisman (ou de la tenniswoman !). L'idée était donc de diminuer la résolution nécessaire, donc de cadrer une image moins large. Nous sommes dit qu'au dessus du terrain celà demanderait de mettre la caméra relativement basse et pouvait être dangereux, donc nous avons étudié une camera sur le coté, à la hauteur du poteau du filet. Ainsi elle ne pourrait cadrer par exemple que 3 mètres ce qui ramenerait notre rapport à 1500 ce qui correspond environ à de la full HD, tout à fait abordable. L'inconvénient étant qu'on ne détecte la balle au dernier moment et le mur n'aura donc pas énormément de temps pour se mettre en place. Une idée naïve serait de se dire que l'on peut placer la camera plus loin dans le terrain par exemple à 6m du filet, mais si la joueur doit monter au filet on ne verra plus rien du tout, ce qui est pire que tout.\\

Finalement après moult recherches nous avons trouvé la caméra M3 de IDT qui correspondait assez bien à nos attentes à un prix contenu (15000€ tout de même), puis nous avons trouvé la Edgertronic qui nous paraissait miraculeuse pour son tarif, mais nous sommes vite rendus compte qu'elle ne proposait bizarrement pas de mode streaming, et ne pouvait fournir une vidéo que par carte SD, ce qui était plus que gênant pour notre système temps réel.\\

Mais le véritable problème de cette solution était la vitesse à laquelle il fallait traiter les images (2ms à 500 images par seconde). Nous n'avons pas réalisé d'algorithme pour cette détection de vitesse de rotation, mais il serait à notre goût plus coûteux que la détection des coordonnées x,y,z. Compte tenu des performances que l'on a atteint d'après le tableau \ref{perf_opencv} cette idée nous est apparu très dur à mettre en place.


Comme nous l'avons vu précédemment une image obtenu par infrarouge serait plus facilement traitable mais les contraintes demeurent les mêmes que pour la détection de la position de la balle.





\subsection{Caméra normale}

Ce n'est pas parce que nous avons abandonné l'idée d'une caméra ultra-rapide que nous avons abandonné par la même occasion l'idée d'une caméra. Comme nous l'avons vu précedemment avec la vitesse de notre algorithme, nous avons estimé que nous pourrions traiter sans problème un flux de 60fps. Il est clair qu'à 60 fps, même avec un temps d'exposition réglable, qu'entre 2 images, un marqueur sur la balle aura largement tourné autour de la balle à la vitesse maximum de 100 tours par seconde. L'astuce consiste donc à se dire qu'avec un "long" temps d'exposition, on a des flous, plus précisémment des trainées, et elles peuvent s'avérer très utiles pour connaitre la rotation de la balle. Imaginons que la balle tourne autour d'un axe qui est celui qui vertical dans le plan de la feuille. Imaginons maintenant que l'on met un marqueur facilement détectable en traitement de l'image. La balle va tourner en avancant, Donc pendant le temps d'exposition la balle aura avancé (vers la gauche par exemple) et le marqueur sera passé une ou plusieurs fois devant la caméra, laissant une ou plusieurs traces d'une certaine longueur (voir figures \ref{img_trainee1} et \ref{img_trainee2}).


\begin{figure}
\centering
\subfigure[Trainée dans le cas d'une rotation selon un axe]{\includegraphics[width=0.45\textwidth]{traine1D.png} \label{img_trainee1}}
\subfigure[Trainée dans le cas d'une composition de rotations]{\includegraphics[width=0.45\textwidth]{traineev1_r2.png} \label{img_trainee2}}\\
\caption{Trainées laissées par un marqueur dans le cas d'une exposition longue}
\end{figure}

En connaissant la vitesse de la balle et la vitesse de la caméra, on peut en déduire la vitesse de rotation de la balle grâce aux nombre de trainées et à leur longueur. Seulement on a imaginé ici le cas avec une seule composante. En imaginant que la rotation ait aussi une composante selon l'axe de la largueur de la feuille on imagine que les trainées ressembleront à des virgules et que le calcul des vitesses de rotations se complexifie largement. Ajoutons maintenant 2 composantes à notre vitesse de translation, et une troisième composante à la rotation, ce qui représente la réalité. Eh bien on se retrouve avec quelque chose d'indigeste et nous n'avons rien put conclure de ces trainé en multidimensionnel ... Nous avons imaginé mettre des marqueurs parfois exotiques pour avoir des trainées distinctes selon les axes en jeu, mais rien de concluant n'est ressorti de cette étude, et nous avons donc définitivement abandonné l'idée de capter cette information de rotation directement par une(des) caméra(s).\\

Nous avions aussi imaginé la solution infrarouge avec une caméra normale pour obtenir notre trainée, mais les problèmes intrinsèques à ces trainées restaient toujours présent et nous n'avons donc pas put conclure sur quelque chose de satisfaisant.\\


\subsection{Balle intelligente}

Maintenant que notre option caméra était bel et bien enterrée, il nous fallait trouver une autre technologie pour acquérir ces données. Malgré le principe que nous nous étions fixé au départ de ne pas imposer trop de contraintes au joueur (balle spéciale, etc), nous ne voyions pas comment calculer cette vitesse sans données optique en sachant que la balle se déplace "aléatoirement" dans un volume relativement grand. Une solution assez naïve mais pas idiote est de placer le capteur, un gyromètre, directement dans la balle, avec une source d'énergie type pile, un controlleur de base et un module de communication sans fil type bluetooth (moins gourmand et les besoins en débit sont plus que limité : 3 doubles de temps en temps). Ainsi le mur peut interroger régulièrement la système de la balle (4 à 10 fois par seconde par exemple), en prenant en compte que plus on l'interroge, plus la pile se videra vite. On a donc une donnée sur la rotation relativement fiable accessible facilement sans calcul. Evidemment ce système a des inconvénient non négligeables : la balle coûtera sensiblement plus cher qu'une balle classique et ne se trouvera pas dans le décathlon du coin, alors qu'une balle vieillit relativement vite au tennis. Par ailleurs la source d'énergie pourra être amené à s'épuiser plus vite que ne l'est la durée de vie de la balle. Nous avons donc pensé au récent système de recharge sans fil qui pourrait remédier à ce problème. Nous n'avons cependant pas de donnée sur la consommation d'un tel système embarqué pour faire une estimmation de la durée de vie de la pile. Par ailleurs il pourrait être utile de pouvoir éteindre le système, car un module comme le bluetooth, même sans envoyer de données, est relativement énergivore, ce qui pourrait poser problème. Mais nous n'avons pas trouvé d'idée cohérente face à ce problème en prenant en compte que le système est isolé par un couche hermétique. \\

Par ailleurs avec un tel système dans la balle on peut imaginer que son équilibrage peut être altéré de façon plus ou moins importante selon le poids du module embarqué, et que ce déséquilibrage peut entrainer une gène pour le joueur de tennis ainsi qu'une modification du comportement de la balle qui a été étudié dans la partie mathématiques. Enfin il faut trouver un système relativement résistant, pour subir des forces centrifuges extrèmes ainsi que des accélérations hors du commun (quelques centaines de g). Néanmoins, il semble qu'un tel système soit tout à fait réalisable puisqu'Adidas a annoncé la commercialisation de sa Smart Ball pour le mois de Juin 2014. C'est un ballon de foot connecté et bourrée de capteurs qui permet d'analyser les coups et de retranscrireavec une grande précision la trajectoire de la balle (apparemment sous la condition d'une frappe de plus de 10m). 

\begin{figure}[h]
\begin{center}
\includegraphics[width=\textwidth]{ballefootintelligente.png}
\caption{Smart Ball d'Adidas}
\label{img:ballefootintelligente}
\end{center}
\end{figure}

\subsubsection{Algorithmie}

Dans ce cas 2 options algorithmique sont possibles : \\
- soit on interroge la balle à temps constant, par exemple 100 ou 200ms (pas trop souvent pour économiser sa batterie, et pas trop peu pour avoir le temps de réagir si la balle a bien avancé depuis la dernière interrogation). Puis à chaque nouvelle donnée on met à jour les données correspondantes sur la partie calcul mathématiques.
- soit on attend d'avoir une vitesse de balle positive (balle qui avance vers le mur) pour faire la requête, ce qui économisera le nombre de requètes, cependant il existe une latence non négligeable (de l'ordre de 100ms) sur tous les systèmes sans fil. Il est donc possible que cette latence ne nous permette pas d'avoir le temps de calculer les données pour le mur

\subsection{Raquette intelligente}

Par hasard en cherchant des solutions sur internet, nous sommes tombés sur un produit intéressant sur le site de Babolat, un fournisseur de matériel de tennis. C'était leur raquette Play and Connect. Cette raquette est bardée de capteur et d'un micro ordinateur dans son manche. Ainsi elle est capable d'analyser nombre d'information sur chaque coup joué par le joueur comme le montre cette page web : https://www.babolatplay.com/features \\

De plus la raquette est équipée d'un module bluetooth qui permet de diffuser ces informations en temps réel, initialement prévu pour envoyer ces données à un smartphone possédant l'application dédiée, mais il est concevable de détourner cette fonction pour récupérer ces données sur le PC du mur. Au niveau des contraintes, comme on peut s'y attendre, le prix de la raquette est deux fois plus élevé qu'une raquette de même qualité sans électronique embarqué et devrait avoisiner les 500€. Une autre contrainte est celle de l'autonomie de la raquette, celle ci étant de 6h selon le constructeur, elle apparait comme très correcte pour un entrainement de tennis, même de longue durée.\\

Cependant le système actuel ne serait pas capable de fournir la vitesse de rotation de la balle. Mais il serait peut-être possible de l'obtenir mathématiquement grâce aux informations de puissance, de spin, etc mais nous n'avons pas eu le temps d'étudier ce modèle. Il est à noter qu'une prochaine version de cette Babolat Play and Connect pourrait fournir ces informations et donc être une solution de choix pour ce mur de tennis intelligent.

\begin{figure}[h]
\begin{center}
\includegraphics[width=\textwidth]{babolatplayandconnect.jpg}
\caption{Babolat Play and Connect}
\label{img_babolatplayandconnect}
\end{center}
\end{figure}




\subsection{Conclusion}

Par rapport à la détermination de la vitesse de rotation de la balle, notre position a énormément évolué. Les parties ci-dessus décrivent chronologiquement nos points de vue et expliquent pourquoi nous avons abandonné ces idées, comme par exemple à cause du coût, des définitions extrêmes et du temps de traitement trop important avec des caméra ultra rapides, du problème d'algorithmie avec une caméra simple, et des problèmes inhérent à l'usage d'une balle ou d'une raquette intelligente.\\

Finalement nous avons décidé d'abandonner la détermination de cette vitesse de rotation par notre partie et c'est le module mathématique qui se charge de trouver cette vitesse avec l'effet magnus visionné par les captures de position et de vitesse. Le détail de ce calcul sera détaillé plus tard. Cependant si Babolat conçoit une raquette fournissant ces informations ou que la puissance des ordinateur explose encore, avec l'utilisation de caméras très rapides alors remise au goût du jour, nous pourrions déterminer précisément ces données.





























\chapter{Détection du joueur}

On s'intéresse dans cette partie à la détection du joueur, pour pouvoir décider de la position de la balle que l'on renvoie avec le mur en fonction du style de jeu qui aura été décidé par le joueur lui-même. On s'intéressera donc aussi bien à la position du joueur mais aussi à son déplacement, pour pouvoir déterminer son intention (pour pouvoir prendre le joueur à contre-pied par exemple), mais aussi l'effort fourni depuis le début de l'entraînement (nombre de calories brûlées, distance parcourue et autres statistiques du genre). \\

Cette partie est bien moins complexe que la précédente étant donné les vitesses de déplacement bien moindre donc des contraintes temporelles moins fortes et aussi une précision requise bien inférieure à celle requise pour la détection de la balle. Comme dans le cas de celle-ci, on a une multitude de solutions techniques qui permettent de réaliser cette détection. Si certaines solutions pour la détection de la balle permettent aussi de détecter la position du joueur, il peut être bon d'avoir un capteur dédié à cela, les données provenant du capteur détectant la balle peuvent servir à confirmer celles de la solution dédiée.


\section{Balayage laser}

Une des premières approches serait d'utiliser un balayage laser pour détecter le joueur. En fonction du positionnement du capteur, on peut vouloir un balayage sur 90$^\circ$ dans le cas d'un capteur sur l'un des côtés du filet (ou dans un des coins du terrain, côté joueur) , ou 180$^\circ$ si on décide de placer le capteur au centre du terrain au niveau du filet. On préferera placer les capteurs au niveau du filet puisque si on les place côté joueur, il faut laisser une certaine distance de sécurité pour qu'ils ne gênent le joueur dans aucun cas, ce qui fait augmenter la portée que doit avoir le capteur. Dans ce dernier cas, les capteurs sont aussi plus sujets à prendre des coups s'ils sont placés derrière le joueur (balles non rattrapées par le joueur par exemple). La figure \ref{img_joueurpositionlaser} reprend les différentes configurations possibles pour le positionnement du capteur. 

\begin{figure}[h]
\begin{center}
\includegraphics[width=\textwidth]{joueurpositionlaser.png}
\caption{Différents positionnement du capteur à balayage}
\label{img_joueurpositionlaser}
\end{center}
\end{figure}

Comme expliqué dans le chapitre sur la détection de la balle, la partie traitement des données envoyées par le capteur est assez simple. Si cette solution est choisie, il faudra cependant prendre plusieurs aspects en compte : 

\begin{itemize}
\item Ne pas provoquer de lésions oculaires dans le cas où le joueur regarde dans la direction du laser. On devra donc choisir un laser de classe 1 ou 2
\item La hauteur à laquelle est placée le capteur : on le placera par exemple à 1 mètre de haut afin de bien pouvoir détecter le joueur. 
\item Il faudra avoir une portée d'au moins 17 mètres dans le cas des lasers placés aux bords des terrains, 13 mètres dans le cas du laser placé au centre du terrain au niveau du filet et 16 mètres dans le cas du capteur placé au centre du terrain mais derrière le joueur (avec 3 mètres entre le fond de court et le capteur\\)
\end{itemize}

Un laser tel que le LMS500 de SICK\footnote{https://www.mysick.com/PDF/Create.aspx?ProductID=55907\&Culture=fr-FR} semble donc être une bonne référence mais son prix est quelque peu prohibitif (9 000\$). Le PS80-90 de Triple-In\footnote{http://www.triple-in.de/fileadmin/user\_upload/datenblaetter/2d-laserscanner/PS80-90\_E.pdf} semble aussi être une bonne référence mais impossible d'avoir son prix. 


\section{Caméra}

Pour la détection avec la caméra, on peut utiliser la caméra qui sert à la détection de la balle, ce qui économise donc un capteur. Pour détecter le joueur, étant donné que les contraintes temporelles sont moins fortes, on peut utiliser des fonctions plus complexes de la bilbiothèque d'OpenCV comme les fonctions d'extraction d'arrière-plan qui permettraient de trouver le joueur dans l'image. Cela prendrait bien plus de temps qu'en utilisant des lasers mais le temps n'est pas vraiment un problème dans ce cas. Si jamais la vitesse d'exécution du script est trop importante, on pourra se souvenir qu'une grande précision n'est pas nécessaire dans ce cas et ainsi travailler avec des images ayant une résolution bien inférieure à la résolution d'origine de la caméra puisque le joueur représente 5\% de la largeur (en supposant une envergure moyenne, toutes positions du joueur confondues, de 50 cm) du terrain et donc de l'image. \\ 


Quelques tests rapides donnent des temps d'exécution pour la suppression de l'arrière-plan de 50 ms pour une résolution d'image de 640 par 480, on peut donc espérer que l'algorithme entier tourne à 10Hz, ce qui devrait être largement suffisant pour détecter la position du joueur ainsi que ses intentions. 


\section{Conclusion}

Quelques tests seraient nécessaires afin d'évaluer si la solution qui réutilise la caméra peut suffire mais dans le cas contraire, utiliser un capteur laser au niveau du filet, placé entre 50 et 80 cm du sol, semble tout à fait possible, d'autant plus que dans ce cas, l'interprétation des données du capteur est relativement simple et rapide. 




















\chapter{Commande du Mur}

Evidemment lorsque l'on a tous nos résultats de position pour le mur, il faut envoyer les consignes à ceux ci pour qu'ils se mettent en place. L'ordinateur qui les gère communiquera donc avec des controlleurs directement implémentés sur chaque plateformes 6 vérins. Ces controlleurs gèreront ensuite les actionneurs pour mettre le tout en mouvement. 

Pour permettre au mur de bouger il fallait choisir ses actionneurs. Nous avons porté notre choix sur des vérins car il permettent de développer d'importants effort en translation. Pour la rotation cela sera fera via une plateforme 6 vérins relativement connue qui sera plus détaillée dans la partie dédiée à la mécanique. La commande se fera via des électrovannes pour amener la pression dans les vérins.

\section{Contrainte de temps}

Le temps que nous nous sommes fixés pour réagir est celui d'un coup droit très fort (100km/h) depuis le fond du terrain, ce qui nous donne 500ms à partir du moment ou la balle est frappé pour que le mur soit en place. \\
Au niveau des temps de réactions de chaque module, on a 35 ms au niveau du traitement d'images (traitement de 3 images pour en déduire 2 vecteurs vitesses et 3 positions nécessaire pour le module mathématique), puis 70 ms de traitement de la partie mathématique pour obtenir les angles que les murs doivent prendre. Ensuite il y a un temps de réponse de la partie controlleur, majoritairement due au temps de réaction des électrovannes du circuit hydraulique, qui est normallement de 25 à 60ms pour passer d'une position extrême à l'autre, nous prendront donc 60 ms par sécurité ; puis le temps de réaction du mur (mise en mouvement de celui ci en comptant son inertie) de 200ms.\\
Au final tout cela nous donne un temps de réaction de 365ms, soit une marge de 135ms, soit 27\% ce qui reste confortable dans les cas les plus critiques (balle qui n'est pas détectée tout de suite, joueur qui frappe fort mais du milieu du terrain, etc).

\section{Application des angles calculés}

Les controlleurs seront des systèmes asservis de type PID qui recevront une consigne de position et controlleront les électrovannes pour que chaque mur se retrouve dans la position correspondant à la consigne assignée. Il faudra donc des vannes qui ne soient pas du type On/Off pour un fonctionnement fin. Les controlleurs PID devront donc être les plus performants possible pour atteindre la consigne le plus rapidement possible et assurer la réaction du mur en 260 ms (inertie du mur + temps de réaction des électrovannes) en évitant bien sûr les instabilités.\\
L'ordinateur pourra envoyer de nouvelles consignes plus fin s'il a eu le temps d'en calculer une autre avant l'impact pour que le mur soit dans une meilleure position. Les controlleurs devront donc être capables de s'adapter rapidement à une nouvelle consigne, ce qui ne devrait pas poser de problème avec un controlleur de type PID.


\chapter{Conclusion}

\section*{Travail réalisé}
Pour conclure sur la partie électronique et informatique, on peut constater que de nombreuses voies ont été explorées. Parmi celle concernant la détection de l'état de la balle, hors rotation, nous avons vu qu'une acquisition par caméra convenait très bien à nos besoins en termes de temps, de qualité et de prix. Car une bonne caméra reviendrait à environ 5000€ et un ordinateur relativement puissant à environ 1000€.\\

Au niveau de la vitesse de rotation, comme on l'a vu, l'acquisition coûterait trop cher à la fois en temps et en prix, bien que ce dernier soit un paramètre modulable. Du coup c'est le module mathématiques qui s'occupe de calculer une vitesse approximative mais que l'on a jugé suffisamment précise dans un premier temps.\\

Pour détecter le joueur la solution laser est pratique car elle ne nécessite pas de traitements importants, mais elle coûte relativement cher, notamment lorsque l'on sait que l'on a déjà un capteur capable de tirer cette information : la caméra qui détecte la position et la trajectoire de la balle. Pour un même résultat la solution caméra est donc beaucoup plus intéressante financièrement. Cependant ceci nécessite encore une puissance de calcul supplémentaire. A partir de ceci et de la puissance de calcul nécessaire pour le module mathématiques, une configuration avec deux unités de calcul qui communiquent par ethernet est solution qui nous semble très intéressante, qui chiffrera donc à environ 2000€.\\

Enfin au niveau de la commande du mur, la simple utilisation de controlleurs PID avec des électrovannes est une solution commune qui fonctionne bien avec ce genre de système, de plus cette technologie est suffisamment réactive et peut être facilement mise à jour, ce qui est adapté à notre système. Enfin le coût reste contenu.\\

\section*{Ce qu'il reste à faire}

Malgré une exploration assez large des différentes solutions techniques possibles pour les différentes parties du projet, le fait de ne pas avoir de budget pour ce projet nous a empêché de faire de nombreux tests et il serait donc plus que bienvenu que de pouvoir faire quelques tests avec les différents éléments matériels sélectionnés afin de pouvoir confirmer ou infirmer nos choix, mais aussi nos algorithmes. \\

Nous avons pu constater que notre partie filtrage comportait quelques imperfections et qu'il y avait un certain nombre de faux positifs que nous avons pu identifier et qu'il conviendrait donc du supprimer. La plupart de ces faux positifs proviennent du fait qu'on ne filtre pas sur la saturation; ce qui laisse donc passer le blanc et le gris, qu'on peut retrouver sur les lignes du terrain. \\

Un aspect assez peu traité dans cette partie est celui de la commande de la plateforme 6 axes. Si un controlleur PID semble le choix le plus adapté, il manque néanmoins les ordres à envoyer au système en fonction des angles que l'on souhaite voir prendre le mur. \\


Il a de plus été question d'utiliser plusieurs unités de calcul dans le cas de la détection du joueur par la caméra, mais aussi dans le cas d'utilisation de plusieurs caméras. Il serait donc intéressant de s'intéresser aux problématiques réseaux afin de faire communiquer ces différentes unités de la manière la plus efficace et rapide possible. \\  

La détection de la rotation de la balle n'a donné lieu à aucune solution technique considérée comme viable. Cependant, on peut imaginer utiliser deux caméras, une pour la détection de la position de la balle ainsi que sa vitesse de translation, et une pour la détection de la rotation. Si la première analyserait en permanence les images obtenues (possible à la vue des temps d'exécution), on pourrait ne déclencher l'analyse des images de la seconde,  ultra-rapide, placée au niveau du filet, que lorsque la balle passe à son niveau et seulement quelques images. \\

Une partie non discutée dans ce rapport est celle concernant les algorithmes de jeu, leur détermination mais aussi leur sélection via une interface graphique à définir. En plus d'un mode très guidé où le joueur choisit le genre de coup qu'il veut avoir en fonction de l'entraînement qu'il souhaite (endurance, mode qui fait courir au maximum le joueur, réactivité, mode qui n'hésitera pas à faire des contrepieds au joueur, ...), on peut imaginer un mode de rejeu de jeux de grands joueurs, avec éventuellement une détermination de ces jeux par analyse logicielle de ces jeux. Il conviendra donc de prêter une attention particulière à la détermination de l'intention du joueur même si cela ne semble pas très compliqué de premier abord. \\